
    
    <div class="container">

        

        <div id="component"></div>
    </div>

    
    <script type="text/javascript">

        // Map FieldData & workflow according to FieldData & workflow in config.js
        var workflow =  FormMaster[MasterFormID].Workflow;
        var TempCurrentData = FormMaster[MasterFormID].FieldData;
    
        // Declare global variable
        var FormID = GetParameterByName('FormID');
        var FormType = 'FormView';
        var ListData = 'list name of store current form data'; // listname store for current item
        var SummaryPage = SiteUrl + '';// dashboard after submit form

        
       
        /////////////////////////////////////
    
        // Place For trigger for DOM 
        $('#CloseForm , #CloseForm2').click(function(){
            CloseForm(0,SummaryPage); 
        });
        
        function RemoveCurrentForm(){
            // Get ID Form by FormID
            var query = '?$select=ID&$top=1&$filter=FormID eq \''+FormID+'\'';
            var data = GetItemByRestAPI(ListData, query);
            if(data){
                RemoveListItem(ListData,data[0].ID);
            }
            
        }
        
        $( "input" ).change(function() {
            
                var str = $(this).val();
                if (str.indexOf(';') > -1 || str.indexOf('[') > -1 || str.indexOf(']') > -1 || str.indexOf('|') > -1)
                {
                    $(this).css("background-color","red");
                    $(this).css("color","white");
                    alert('Don\'t input "; [ ] |" ');  
                }
                else{
                    $(this).css("color","black");
                    $(this).css("background-color","white");
                    
                }
    
        });
    
        $('input').keypress(function(event){
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if(keycode == '13'){
                event.preventDefault();
                return false;
            }
        });
        ///////////////////////////////
        
    
        // Set inittial form  
        // such as option in select , default date, default current user , default text and label
        function SetInitialForm(){
            
         
            
            
            //IncludeComponent('ElementID','ComponentName');
            IncludeComponent('component','RightNavMenu');

        }
    
        // Get Data when user click view an item. this will be called by FormView();
        // if user click new item this function will not be called
        function GetData(){ // FormMethodTemplate

            var query = '';
            var data = GetItemByRestAPI(ListData,query);
         
            if(data){
                if(data.length > 0){
    
                    data = data[0];
                    
                    var name = data[workflow.name];
                    
                    CheckStatusWorkflow(name , workflow.version);  // FormMethodTemplate
                    
                    for(var i in TempCurrentData){
                    
                            var item = TempCurrentData[i];
                            var TempData = data[item.Col];
                            
                            // Get and set data in element by item data
                            SetElementByItemData(item,TempData);   
                    }
                }
                else{

                    RoutingPage('PageItemNotFound.html'); // FormMethodTemplate
                }
                return data;
            }
    
    
        }
    
        // Form display when user click new form .
        // what you do want to display or change element new form.
        // input action to this function
        function FormNew(){
            // set panel status 
            $('#DocNO').text('-');
            $('#CreateDate , #RequestDate').text(SetDateTime()); 
            $('#FormStatus').text('Create');
            
            SetFormAction(); // FormMethodTemplate
        
            
            
            // Set Panel People end of section 1
            $('#Requestor').val(CurrentUser.Name);
            $('#Requestor').attr('title',CurrentUser.ID);
            // End Set Panel People end of section 1

            //hide button remove right nav
            $('#RemoveCurrentForm').hide();

            // Disable part 2 exclude admin 
            if(CurrentUser.Permission == 'Admin'){
                $('#Permission').text('Admin'); 
            }
            else{ // not admin
                $('#Permission').text('Requestor');
              
            } 
            
            
           
        }
    
        // Form display when user click view an item.
        // if user click new item this function will not be called.
        function FormView(){
            var data = GetData();
            Queryfile();
            
            if(data){
                Form.FormStatus = data.FormStatus;
                SetFormAction(); // FormMethodTemplate
       
                if(data.Dept_Target){
                    GetDeptTarget(data.Dept_Target);
                }
                
                // Set top right info
                $('#DocNO').text(data.RunningNO);
                $('#CreateDate').text(ConvertDate(data.Created)); 
                $('#FormStatus').text(data.FormStatus);
                
                
        
                // Map Current view according to FormView in config.js
                Form.FormView = FormMaster[MasterFormID].FormStep[Form.FormStatus].FormView;
            
                if(Form.FormView){
                    SwitchViewTo(Form.FormView,data);
                }
                else{
                    Disable_Panel('All');
                }

            }

            // Create View or switch view according to config.js
            function SwitchViewTo(view){
                switch(view){
                    
                    case 'สร้างเอกสาร':

                            CurrentRole(data.Requestor.Title,'ผู้สร้างเอกสาร');
                            break;
                    
                    case 'Complete':
                            $('#btnSaveDraft').hide();
                            Disable_Panel('All');
                            break;
    
                }

            }
            // End Create View or switch view according to config.js


            function Disable_Panel(PartID){

                    if(PartID == 'All'){

                        $('#Permission').text('Visitor');
                        $('body *').attr('readonly', true);
                        $('body *').css('cursor', 'no-drop');
                        $('body *').on('mousedown', function(e) {
                                e.preventDefault();
                                this.blur();
                                window.focus();
                        });
                        $('body').removeAttr('onclick');
                        $('#Approval').hide();

                    }else{
                        
                        $('#'+PartID+' *').attr('readonly', true);
                        $('#'+PartID+' *').css('cursor', 'no-drop');
                        $('#'+PartID+' *').on('mousedown', function(e) {
                                e.preventDefault();
                                this.blur();
                                window.focus();
                        });
                        $('#'+PartID+' *').removeAttr('onclick');

                    }    
            }

            function CurrentRole(Role,TitleRole){

                 
                    if(CurrentUser.Name == Role || CurrentUser.Permission == 'Admin'){
                        if(CurrentUser.Name == Role && CurrentUser.Permission == 'Admin'){ // admin & current role
                            $('#Permission').text(TitleRole);
                           
                            
                        }
                        else if(CurrentUser.Name == Role && CurrentUser.Permission != 'Admin'){ // current role no admin
                            $('#Permission').text(TitleRole);
                            //hide button remove right nav
                            $('#RemoveCurrentForm').hide();
                        }
                        else{// admin no current role
                            $('#Permission').text('Admin');
                             
                            
                        } 
                    }else{
                        
                        Disable_Panel('All');
                        //hide button remove right nav
                        $('#RemoveCurrentForm , #btnSaveDraft').hide();
                        
                    }
            }
    
        }
    
        // when user click submit action will take action in this function      
        function SubmitAction(){ // FormMethodTemplate
            
            // disable submit button
            $('#SubmitAction').prop('disabled',true);
    
    
            var ActionTitle = $("#Approval_Select option:selected").text();
            Form.StatusAction = $('#Approval_Select').val();
            Form.FlagSubmit = true;
            if(Form.StatusAction != 0){
                $('#MainModal').modal('show');
                AddLoading();
                $('#TitleModal').text(ActionTitle);
    
                TriggerTempData();
    
                // Validate 
                var FlagValidatePass = ValidateData(); // FormMethodTemplate
                // enable submit button
                $('#SubmitAction').prop('disabled',false);
                if(FlagValidatePass == false){
                    return;
                }
                
                var StatusCreate = CheckUpdateOrCreate(ListData); // FormMethodTemplate
                switch(StatusCreate){   // FormMethodTemplate
                    case 'Create':
                        
                            
                                CreateListItem(ListData,TempCurrentData); // FormMethodTemplate
                           
                                
                            
                            break;
                    case 'Update':
                            
                                UpdateListItem(ListData,TempCurrentData); // FormMethodTemplate
                            
                            break;
                }
                
                UpdateFlagAttachment(); // FormMethodTemplate
                HistoryLog('add'); // FormMethodTemplate
    
                var delayInMilliseconds = 1500; //1 second
                setTimeout(function() {
                    CloseForm(1,SummaryPage); // FormMethodTemplate
                }, delayInMilliseconds);
            }
            else{
                alert('Please select any action..');
                
                // enable submit button
                $('#SubmitAction').prop('disabled',false);
            }
    
        }
    
        function TriggerTempData(){
            for(var i in TempCurrentData){
    
                        var field = TempCurrentData[i];
                    
                            switch(field.TypeDom){
                                case 'text':
                                                field.Data = $('#'+field.ID).val();
                                                break;
                                case 'textarea':
                                                field.Data = $('#'+field.ID).val();
                                                break;
                                case 'date':
                                                var tempdata = $('#'+field.ID).val();

                                                if(tempdata){
                                                    field.Data = $('#'+field.ID).val();
                                                }
                                                else{
                                                    field.Data = '';
                                                }
                                                
                                            
                                                break;

                                case 'label':
                                                field.Data = $('#'+field.ID).text();
                                            
                                            
                                                break;
                                case 'select':
                                                
                                                if(field.TypeCol == 'people'){  // in case select query from people 
                                                    if($('#'+field.ID).val() != '-'){
                                                        field.Data = {
                                                            //ID: $('#'+field.ID).val(),
                                                            ID: $('#'+field.ID + ' option').eq($('#'+field.ID).prop("selectedIndex")).val(),
                                                            Title: $('#'+field.ID+' option:selected').text()
                                                        }
                                                    }
                                                
                                                }
                                                else{ // in case select query from normal text
                                                    field.Data = $('#'+field.ID).val();
                                                }
                                                break;
                                case 'people':  
                                            
                                                field.Data = {
                                                    ID: $('#'+field.ID).attr('title'),
                                                    Title: $('#'+field.ID).val()
                                                }
                                                

                                                break;
                                case 'check':
                                                if ($('#'+field.ID).is(":checked"))
                                                {
                                                    field.Data = true;
                                                }
                                                else{
                                                    field.Data = false;
                                                }
                                                break;
                                case 'var':
                                                field.Data = field.Data;
                                
                                                break;
                                case 'radio':
                                                field.Data = $('input[name='+field.ID+']:checked').val();
                                                if(!field.Data){
                                                    field.Data = '';
                                                }
                                
                                                break;
                                case 'array':
                                                    var tempdata = field.Data;
                                                    field.Data = tempdata.toString();
                                    
                                                    break;
                                case 'object':  
                                                var index = field.ID;
                                                var sum_str = '';
                                                if(index == 'T41' || index == 'T42' || index == 'T43' || index == 'T44' || index == 'T45'){
                                                    for(loop=1;loop<=10 ;loop++){
                                                        var TempID = index + '_Col' + loop;
                                                        var type = $("#"+TempID).attr("type");
                                                        var TempCheck;
                                                        switch(type){
                                                            case 'checkbox':

                                                                            if ($('#'+TempID).is(":checked"))
                                                                            {
                                                                                TempCheck = 'true';
                                                                            }
                                                                            else{
                                                                                TempCheck = 'false';
                                                                            }
                                                                            
                                                                            sum_str += '['+TempID+'|'+TempCheck+'];';
                                                                            
                                                                            break;
                                                            case 'text':
                                                                            var TempData = $('#'+TempID).val();
                                                                            sum_str += '['+TempID+'|'+TempData+'];';
                                                                            

                                                                            break;

                                                        }
                                                        
                                                    }
                                                    field.Data = sum_str;
                                                }
                                                else{
                                                    for(loop=1;loop<=100;loop++){
                                                        var TempID = index + '_Col' + loop;
                                                        var TempData = $('#'+TempID).val();
                                                        if(!TempData){
                                                        
                                                        }
                                                        else{
                                                            sum_str += '['+TempID+'|'+TempData+'];';
                                                        }     
                                                    }
                                                    
                                                    field.Data = sum_str;
                                                }
                                                
                                                break;
                            
                            } 
                    }      
    }
    
        function SaveDraft(){
            
                $('#MainModal').modal('show');
                AddLoading();
                $('#TitleModal').text('Save Draft');
                TriggerTempData();
              
                var StatusCreate = CheckUpdateOrCreate(ListData);
                switch(StatusCreate){   
                    case 'Create':
                           
                                CreateListItem(ListData,TempCurrentData);
                                UpdateFlagAttachment(); 
                            break;
                    case 'Update':
                            
                                UpdateListItem(ListData,TempCurrentData);
                                UpdateFlagAttachment(); 
                            break;
                }
                
              
                
        }
       
</script>
    
    